<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <title>XRPL TX Exporter</title>
    <script src="./xrpl-tx-export.js"></script>
    <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
    <script>
      function exportToCsv(filename, rows) {
        var processRow = (row) => {
          var finalVal = ''
          for (var j = 0; j < row.length; j++) {
            var innerValue = row[j] === null ? '' : row[j].toString()
            if (row[j] instanceof Date) {
              innerValue = row[j].toLocaleString()
            };
            var result = innerValue.replace(/"/g, '""')
            if (result.search(/("|,|\n)/g) >= 0)
              result = '"' + result + '"';
            if (j > 0)
              finalVal += ',';
            finalVal += result;
          }
          return finalVal + '\n'
        }

        var csvFile = '';
        for (var i = 0; i < rows.length; i++) {
          csvFile += processRow(rows[i])
        }

        var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' })
        if (navigator.msSaveBlob) { // IE 10+
          navigator.msSaveBlob(blob, filename)
        } else {
          var link = document.createElement("a")
        if (link.download !== undefined) { // feature detection
            // Browsers that support HTML5 download attribute
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url)
            link.setAttribute("download", filename)
            link.style.visibility = 'hidden'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        var exportModule = require('xrpl-tx-export')

        new Vue({
          el: '#exporter',
          data: {
            account: '',
            transactions: [],
            started: false,
          },
          computed: {
            fields: () => {
              return ['use' ,...exportModule.fields]
            },
            dispFields: () => {
              return exportModule.fields.filter((f) => {
               return f !== 'hash' && f !== 'currency' && f !=='transactionType' && f !=='use'
              })
            }
          },
          methods: {
            exportCsv: function() {
              const csvHeader = [exportModule.fields.filter((f) => {
                return !(f === 'hash' || f === 'currency' || f=== 'transactionType')
              })]
              return exportToCsv(this.account + '.csv',
                csvHeader.concat(this.transactions.filter((tx) => {
                  return tx.use
                })
                .map((tx)=> {
                  return csvHeader[0].map((field) => {
                    return String(tx[field])
                })
              })))
            },
            start: async function () {
              this.started = true
              this.transactions = []
              var vThis = this
              let storedTx
              await exportModule.app(this.account, (tx) => {
                let befTx = undefined
                
                if(vThis.transactions && vThis.transactions.length > 0){
                  befTx = vThis.transactions[vThis.transactions.length - 1]
                }

                if(befTx && befTx.transactionType == 'OfferCreate' && befTx.timestamp == tx.timestamp){
                  const fixed = befTx
                  if(fixed.base == 'XRP' && parseFloat(fixed.volume) < 0){
                    // buy issued token
                    const xrpVol = fixed.volume * -1
                    fixed.action = 'BUY'
                    fixed.counter = 'XRP'
                    fixed.base = tx.base
                    fixed.volume = tx.volume
                    fixed.price = tx.volume / xrpVol
                  } else if(fixed.base == 'XRP' && parseFloat(fixed.volume) > 0){
                    // sell issued token
                    const xrpVol = fixed.volume
                    fixed.action = 'SELL'
                    fixed.counter = 'XRP'
                    fixed.base = tx.base
                    fixed.price = tx.volume / xrpVol
                  }
                  vThis.transactions[vThis.transactions.length - 1] = fixed
                }else{

                  vThis.transactions.push({...tx, use:true })
                }
              })
              
              const getCurrency = (target) => {
                if (target==='XRP') {
                  return { currency: 'XRP'}
                } else {
                  const [counterparty, currency] = target.split(".");
                  return {
                    currency:
                      currency.length === 3
                        ? currency
                        : exportModule.string2hex(currency).toUpperCase().padEnd(40, "0"),
                    counterparty: counterparty,
                  }
                }
              }
                
              const fetchPrice = async (baseParam, counterParam, timestamp) => {
                const base = `${baseParam.currency}${baseParam.counterparty?'+'+baseParam.counterparty:''}`
                const counter = `${counterParam.currency}${counterParam.counterparty?'+'+counterParam.counterparty:''}`
                
                const response = await fetch(`https://data.ripple.com/v2/exchange_rates/${base}/${counter}?date=${timestamp}`)
                const data = await response.json()
                return data.rate
              }
                
              await vThis.transactions.forEach(async (tx, idx) => {
                await exportModule.fields.forEach(async (field) => {
                  if(field === 'price' && tx['transactionType'] !== 'OfferCreate' && tx.base !== 'XRP' && tx.counter === 'XRP'){
                    const [counterparty, currency] = tx.base.split(".");
                    const base = getCurrency(tx.base);
                    const counter = getCurrency(tx.counter);
                    vThis.transactions.splice(idx, 1, 
                      {
                        ...vThis.transactions[idx],
                        price: await fetchPrice(base,counter,tx['timestamp'])
                      }
                    )
                  }
                })
              })
            },
          }
        })
      })
    </script>
    <style>
      table>tbody>tr>td {
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-2">
      <h3>XRPL Transaction Explorer For Japanese tax calculation</h3>
      <h6><small>By <a href="https://wietse.com/xrpl">Wietse Wind</a> - <a href="https://github.com/WietseWind/xrpl-tx-exporter-csv">Source (GitHub)</a> (Original) </small></h6>
      <h6><small>By <a href="https://tequ.dev/">TeQu</a> - <a href="https://github.com/develoQ/xrpl-tx-exporter-csv">Source (GitHub)</a></small></h6>
      <div id="exporter" class="pt-2 mt-3 border-top">

        <div class="" v-if="!started">
          <h5>Enter your account address:</h5>
          <input type="search" placeholder="r..." v-model="account" class="input form-control input-lg form-control-lg">
          <div class="d-inline-block">
            <button @click="start" :disabled="account === ''" class="btn btn-primary btn-lg py-1 mt-2 d-block">Fetch transactions</button>
          </div>
        </div>
        <div v-if="started">
          <div class="row" justify="center">
            <div class="col-12 col-lg-4 mt-2">
              <div class="card shadow-sm">
                <div class="card-body">
                  Account:<br />
                  <code class="text-primary"><b>{{ account }}</b></code>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-4 mt-2">
              <div class="card shadow-sm">
                <div class="card-body">
                  Transactions:<br />
                  <code class="text-primary"><b>{{ transactions.length }}</b></code>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3 mb-4 text-center">
            <button @click="exportCsv" class="btn btn-lg btn-primary py-1">Export (CSV)</button>
          </div>

          <div class="table-responsive mt-4">
            <table class="table table-condensed table-striped table-hover table-sm">
              <thead>
                <tr>
                  <th v-for="field in fields">
                    <small v-if="field !== 'transactionType'"><code>{{ field }}</code></small>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="tx in transactions">
                  <td>
                    <input type="checkbox" v-model="tx.use"/>
                  </td>
                  <td v-for="field in dispFields">
                    <small v-if="field !== 'hash' && field !== 'currency' && field !=='transactionType' && field !=='use'">
                      <code class="text-dark">{{ tx[field] }}</code>
                    </small>
                  </td>
                </tr>
              </tbody>
            </table>
            {{transactions}}
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
